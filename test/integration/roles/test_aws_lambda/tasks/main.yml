- name: Given that I create lambda
  tags: lambda
  local_action:
    module: lambda
    region: "{{ ec2_region }}"
    name: "{{ resource_prefix }}-lambda"
    state: present
    zip_file: 'upload.zip'
    runtime: "python2.7"
    role: "arn:aws:iam::{{aws_account}}:role/{{ resource_prefix }}-lambda"
    handler: "test_lambda.handler"
    timeout: 10
    memory_size: 128
  register: lambda_result

- name: And I give lambda execution permissions to API gateway
  tags: lambda
  local_action:
    module: lambda_policy
    function_name: "{{ resource_prefix }}-lambda"
    region: "{{ ec2_region }}"
    state: present
    statement_id: allow-api-gateway-lambda
    action: lambda:InvokeFunction
    principal: apigateway.amazonaws.com
    #note that the region is the region where the lambda is even when the API is based
    #in a different region!!
    source_arn: "arn:aws:execute-api:{{ ec2_region }}:{{ aws_account }}:*/*"

- name: When I execute the lambda
  execute_lambda:
    name: test-function
    payload:
      foo: bar
      value: 8
    wait: true
    tail_log: true
  register: response

- name: assert failure when called with no parameters
  assert:
    that:
      - "ansible lambda test" in response.log
